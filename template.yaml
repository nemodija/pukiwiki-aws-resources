AWSTemplateFormatVersion: '2010-09-09'

Parameters:
  ImageId:
    Type: AWS::EC2::Image::Id
    Default: ami-0cc75a8978fbbc969
  InstanceType:
    Type: String
    Default: t2.micro
  SnapshotId:
    Type: String
  AvailabilityZone:
    Type: AWS::EC2::AvailabilityZone::Name
    Default: ap-northeast-1a

Resources:
  Instance: 
    Type: AWS::EC2::Instance
    Properties:
      AvailabilityZone: !Ref AvailabilityZone
      ImageId: !Ref ImageId
      InstanceType: !Ref InstanceType
      Tags:
      - Key: Name
        Value: !Ref AWS::StackName
      IamInstanceProfile: !Ref IamInstanceProfile
      SecurityGroupIds:
      - !Ref SecurityGroup
  IamInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
      - !Ref InstanceRole
  InstanceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
        - Effect: Allow
          Principal:
            Service: ec2.amazonaws.com
          Action: sts:AssumeRole    
      Description: Allows EC2 instances to call AWS services on your behalf.
      ManagedPolicyArns:
      - arn:aws:iam::aws:policy/service-role/AmazonEC2RoleforSSM
  SecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: wiki
      SecurityGroupIngress:
      - CidrIp: 0.0.0.0/0
        FromPort: 80
        ToPort: 80
        IpProtocol: tcp
  Volume:
    Type: AWS::EC2::Volume
    Properties:
      AvailabilityZone: !GetAtt Instance.AvailabilityZone
      SnapshotId: !Ref SnapshotId
      Tags:
      - Key: Name
        Value: !Ref AWS::StackName
  VolumeAttachment:
    Type: AWS::EC2::VolumeAttachment
    Properties:
      Device: /dev/sdf
      InstanceId: !Ref Instance
      VolumeId: !Ref Volume
  LifecyclePolicy:
    Type: AWS::DLM::LifecyclePolicy
    Properties:
      Description: !Sub ${AWS::StackName}
      ExecutionRoleArn: !GetAtt LifecyclePolicyRole.Arn
      PolicyDetails:
        ResourceTypes:
        - VOLUME
        Schedules:
        - Name: !Sub "${AWS::StackName}-daily-snapshot-schedule"
          CreateRule:
            Interval: 24
            IntervalUnit: HOURS
            Times:
            - "15:00"
          RetainRule:
            Count: 3
        TargetTags:
        - Key: Name
          Value: !Ref AWS::StackName
      State: ENABLED
  LifecyclePolicyRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
        - Effect: Allow
          Principal:
            Service: dlm.amazonaws.com
          Action: sts:AssumeRole
      ManagedPolicyArns:
      - arn:aws:iam::aws:policy/service-role/AWSDataLifecycleManagerServiceRole

Outputs:
  ManagedInstanceSessionUrl:
    Value: !Sub https://${AWS::Region}.console.aws.amazon.com/systems-manager/session-manager/${Instance}?region=${AWS::Region}
